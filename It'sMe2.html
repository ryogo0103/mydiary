<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>It'sMe</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,700" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" crossorigin="anonymous">
  <style>
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .filter-button { margin: 2px; }
    .tags span { margin-right: 5px; color: #007bff; }
  </style>
</head>

<body>
  <!-- パスワード入力画面 -->
  <div id="passwordScreen" style="text-align:center; margin-top:100px;">
    <h2>パスワードを入力してください</h2>
    <input type="password" id="passwordInput" placeholder="Password">
    <button class="btn btn-primary" onclick="checkPassword()">Enter</button>
    <p id="passwordMessage" style="color:red;"></p>
  </div>

  <!-- 本体アプリ -->
  <div id="diaryApp" style="display:none;">
    <nav id="mainNavbar" class="navbar navbar-dark navbar-expand-md py-0 fixed-top">
      <a href="#" class="navbar-brand">CANDY</a>
      <button class="navbar-toggler" data-toggle="collapse" data-target="#navLinks" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navLinks" class="collapse navbar-collapse">
        <div class="navbar-nav">
          <a href="#" class="nav-item nav-link">HOME</a>
          <a href="#" class="nav-item nav-link">STUDY</a>
          <a href="#" class="nav-item nav-link">MEMORY</a>
        </div>
      </div>
    </nav>

    <div class="fv-slider">
      <img src="imgs/gumball.png" class="slide active">
      <img src="imgs/hand2.png" class="slide">
      <img src="imgs/milk.png" class="slide">
    </div>

    <div class="main container mt-5 pt-5">
      <div class="row">
        <div class="col-md-6 mainDiary">
          <h1>DIARY</h1>
          <textarea id="diaryText" rows="5" placeholder="text" class="form-control mb-2"></textarea>
          <input id="tagInput" type="text" placeholder="web,game" class="form-control mb-2">
          <button class="btn btn-primary" onclick="saveEntry()">保存</button>
        </div>

        <div class="col-md-6">
          <div class="mainTag mb-3">
            <h2>FILTER</h2>
            <div id="tagFilters"></div>
          </div>
          <div class="mainIndex">
            <h2>INDEX</h2>
            <div id="entries"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

  <!-- スライダー処理 -->
  <script>
    let current = 0;
    const slides = document.querySelectorAll('.slide');
    function showNextSlide() {
      slides[current].classList.remove('active');
      current = (current + 1) % slides.length;
      slides[current].classList.add('active');
    }
    setInterval(showNextSlide, 3000);
  </script>

  <!-- ナビバー色切り替え -->
  <script>
    $(function () {
      $(document).scroll(function () {
        var $nav = $('#mainNavbar');
        $nav.toggleClass('scrolled', $(this).scrollTop() > $nav.height());
      });
    });
  </script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    const APP_PASSWORD = "123";

    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyBKaF3vppk5bWBcWhRjpgBLbWho803LROg",
      authDomain: "diary-f3943.firebaseapp.com",
      projectId: "diary-f3943",
      storageBucket: "diary-f3943.appspot.com",
      messagingSenderId: "968623647212",
      appId: "1:968623647212:web:a019133e3a69ecbbb1f8c9",
      measurementId: "G-6XJP6N4N3G"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // パスワードチェック
    window.checkPassword = function () {
      const input = document.getElementById("passwordInput").value;
      if (input === APP_PASSWORD) {
        document.getElementById("passwordScreen").style.display = "none";
        document.getElementById("diaryApp").style.display = "block";
        startFirestoreSubscription(); // 認証後に購読開始
      } else {
        document.getElementById("passwordMessage").textContent = "パスワードが違います";
      }
    }

    // Firestore購読
    function startFirestoreSubscription() {
      const q = query(collection(db, "entries"));
      onSnapshot(q, (snapshot) => {
        const entries = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
        window.cachedEntries = entries;
        renderEntries(entries);
      });
    }

    // 保存
    window.saveEntry = async function () {
      const text = document.getElementById('diaryText').value.trim();
      const tagText = document.getElementById('tagInput').value.trim();
      if (!text) return;
      const tags = tagText ? tagText.split(',').map(t => t.trim()).filter(Boolean) : [];
      const date = new Date().toLocaleString();
      await addDoc(collection(db, "entries"), { text, date, tags });
      document.getElementById('diaryText').value = '';
      document.getElementById('tagInput').value = '';
    }

    // レンダリング
    function renderEntries(entries, filterTag = null) {
      const container = document.getElementById('entries');
      container.innerHTML = '';
      if (!entries) return;

      if (filterTag) {
        entries = entries.filter(e => e.tags && e.tags.includes(filterTag));
      }

      // タグ生成
      const tagSet = new Set();
      entries.forEach(e => { if (e.tags) e.tags.forEach(t => tagSet.add(t)); });

      const tagContainer = document.getElementById('tagFilters');
      tagContainer.innerHTML = '<button class="filter-button btn btn-secondary btn-sm mb-1" onclick="renderEntries(window.cachedEntries)">すべて表示</button>';
      tagSet.forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'filter-button btn btn-outline-primary btn-sm mb-1';
        btn.textContent = `#${tag}`;
        btn.addEventListener('click', () => renderEntries(window.cachedEntries, tag));
        tagContainer.appendChild(btn);
      });

      // INDEX描画
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry fade-in border p-2 mb-2 rounded';
        div.innerHTML = `
          <div><strong>${entry.date || ''}</strong></div>
          <div style="margin-top: 10px;">${entry.text ? entry.text.replace(/\n/g, '<br>') : ''}</div>
          <div class="tags">${entry.tags ? entry.tags.map(tag => `<span>#${tag}</span>`).join(' ') : ''}</div>
        `;
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-danger btn-sm mt-2';
        delBtn.textContent = '削除';
        delBtn.addEventListener('click', async () => {
          if (confirm('この日記を削除しますか？')) {
            await deleteDoc(doc(db, "entries", entry.id));
          }
        });
        div.appendChild(delBtn);
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
